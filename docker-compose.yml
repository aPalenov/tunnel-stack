networks:
  default:
    name: ${DOCKER_NETWORK:-tunnel-stack-network}
    external: true

services:
  # 3proxy: HTTP (3128) + SOCKS5 (1080)
  threeproxy:
    container_name: tunnel-stack-3proxy
    image: 3proxy/3proxy:latest
    command: ["3proxy", "/etc/3proxy/3proxy.cfg"]
    restart: unless-stopped
    ports:
      - '${HTTP_PROXY_PORT:-3128}:3128/tcp'   # HTTP proxy
      - '${SOCKS_PROXY_PORT:-1080}:1080/tcp'  # SOCKS5 TCP
      - '${SOCKS_PROXY_PORT:-1080}:1080/udp'  # SOCKS5 UDP associate
    volumes:
      - ./docker/3proxy/3proxy.cfg:/etc/3proxy/3proxy.cfg:ro
      - ./docker/3proxy/allow.list:/data/allow.list:rw

  allowlist-ui:
    container_name: tunnel-stack-allowlist-ui
    build: ./docker/allowlist-ui
    restart: unless-stopped
    environment:
      - ALLOWLIST_FILE=/data/allow.list
      - TARGET_CONTAINER_NAME=tunnel-stack-3proxy
      - BASIC_AUTH_USER=${ALLOWLIST_UI_USER:-admin}
      - BASIC_AUTH_PASS=${ALLOWLIST_UI_PASS:-change-me}
    ports:
      - '${ALLOWLIST_UI_PORT:-8080}:8080'
    volumes:
      - ./docker/3proxy/allow.list:/data/allow.list:rw
      - /var/run/docker.sock:/var/run/docker.sock:rw

  pac-service:
    container_name: tunnel-stack-pac-service
    build: ./docker/pac-service
    restart: unless-stopped
    environment:
      - PORT=3000
      - DB_FILE=/app/data/db.json
      - BASIC_AUTH_USER=${PAC_SERVICE_BASIC_AUTH_USER:-admin}
      - BASIC_AUTH_PASS=${PAC_SERVICE_BASIC_AUTH_PASS:-change-me}
    ports:
      - '${PAC_SERVICE_PORT:-3000}:3000'
    volumes:
      # Mount the whole data directory to allow atomic writes and easy host edits
      - ./docker/pac-service/data:/app/data:rw

volumes: {}
